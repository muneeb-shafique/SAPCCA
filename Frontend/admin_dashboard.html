<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>God Mode | SAPCCA Admin</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        },
                        dark: {
                            bg: '#050505',
                            card: '#131316',
                            border: '#27272a'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #050505;
            color: #fff;
            overflow: hidden;
        }

        .glass-panel {
            background: rgba(19, 19, 22, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Modern Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            z-index: -2;
            opacity: 0.6;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col relative">

    <!-- Background -->
    <div class="mesh-bg"></div>
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-[-1]">
        <div
            class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-purple-900 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob">
        </div>
        <div
            class="absolute top-[-10%] right-[-10%] w-96 h-96 bg-blue-900 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000">
        </div>
        <div
            class="absolute bottom-[-20%] left-[20%] w-96 h-96 bg-indigo-900 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-4000">
        </div>
    </div>

    <!-- LOCK SCREEN OVERLAY -->
    <div id="lock-screen" class="fixed inset-0 z-[999] bg-[#050505] flex items-center justify-center">
        <div class="text-center space-y-8 animate-pulse" id="lock-content">
            <div
                class="w-24 h-24 bg-brand-500/10 rounded-3xl flex items-center justify-center mx-auto text-brand-400 ring-1 ring-brand-500/20 shadow-[0_0_50px_rgba(14,165,233,0.25)]">
                <i data-lucide="shield-alert" class="w-12 h-12"></i>
            </div>
            <div>
                <h1 class="text-4xl font-display font-bold tracking-tighter mb-2">RESTRICTED AREA</h1>
                <p class="text-red-500 font-mono text-sm tracking-widest uppercase">Unauthorized Access Prohibited</p>
            </div>

            <form onsubmit="unlockSystem(event)" class="relative max-w-xs mx-auto">
                <input type="password" id="admin-pass"
                    class="w-full bg-white/5 border border-white/10 rounded-xl px-6 py-4 text-center text-xl tracking-[0.5em] focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all font-mono"
                    placeholder="ENTER CODE" autofocus autocomplete="off">
            </form>
        </div>
    </div>

    <!-- MAIN APP (Hidden initially) -->
    <div id="app-container" class="flex flex-col h-screen opacity-0 transition-opacity duration-1000">

        <!-- Header -->
        <header
            class="h-16 border-b border-white/10 bg-black/20 backdrop-blur-xl flex items-center justify-between px-6 sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center shadow-lg shadow-red-500/20 ring-1 ring-white/20">
                    <i data-lucide="zap" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="font-display font-bold text-xl tracking-tight leading-tight">GOD MODE</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                        <span class="text-[10px] text-emerald-400 font-mono tracking-wider uppercase">Live
                            Connection</span>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button onclick="lockDashboard()" title="Lock System"
                    class="p-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="lock" class="w-5 h-5"></i>
                </button>
                <button onclick="logout()" title="Logout"
                    class="p-2 rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="power" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="flex flex-1 overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-72 border-r border-white/10 bg-black/40 backdrop-blur-md flex flex-col pt-6 pb-4">
                <div class="px-6 mb-6">
                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Database Tables</h3>
                    <div id="table-list" class="space-y-1">
                        <!-- Populated by JS -->
                        <div class="h-10 bg-white/5 rounded-lg animate-pulse"></div>
                        <div class="h-10 bg-white/5 rounded-lg animate-pulse delay-75"></div>
                        <div class="h-10 bg-white/5 rounded-lg animate-pulse delay-150"></div>
                    </div>
                </div>

                <div class="mt-auto px-6 border-t border-white/10 pt-6">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Analytics</h3>
                    <button onclick="loadAnalytics()"
                        class="w-full text-left px-4 py-3 mb-2 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 text-gray-300 hover:text-white transition-all flex items-center gap-3 group">
                        <div
                            class="p-1.5 rounded-lg bg-purple-500/20 text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-colors">
                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i>
                        </div>
                        <span class="font-medium">Performance Graphs</span>
                    </button>

                    <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4 mt-6">System Utilities
                    </h3>
                    <button onclick="loadLogs()"
                        class="w-full text-left px-4 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 text-gray-300 hover:text-white transition-all flex items-center gap-3 group">
                        <div
                            class="p-1.5 rounded-lg bg-blue-500/20 text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-colors">
                            <i data-lucide="terminal" class="w-4 h-4"></i>
                        </div>
                        <span class="font-medium">System Logs</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 overflow-hidden flex flex-col relative bg-transparent">

                <!-- KPI Stats -->
                <div class="grid grid-cols-4 gap-6 p-8">
                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="users" class="w-24 h-24 text-white"></i>
                        </div>
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Total Users</div>
                        <div class="text-4xl font-display font-bold text-white tracking-tight" id="stat-users">...</div>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="message-square" class="w-24 h-24 text-white"></i>
                        </div>
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Messages</div>
                        <div class="text-4xl font-display font-bold text-white tracking-tight" id="stat-messages">...
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="user-plus" class="w-24 h-24 text-white"></i>
                        </div>
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider mb-2">Friend Req</div>
                        <div class="text-4xl font-display font-bold text-white tracking-tight" id="stat-reqs">...</div>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl relative overflow-hidden group border-red-500/20">
                        <div class="absolute right-0 top-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                            <i data-lucide="alert-triangle" class="w-24 h-24 text-red-500"></i>
                        </div>
                        <div class="text-red-400 text-xs font-bold uppercase tracking-wider mb-2">System Errors</div>
                        <div class="text-4xl font-display font-bold text-white tracking-tight" id="stat-logs">...</div>
                    </div>
                </div>

                <!-- Table Header & Actions -->
                <div class="px-8 flex items-center justify-between mb-4">
                    <h2 id="current-view-title" class="text-2xl font-display font-bold flex items-center gap-3">
                        <i data-lucide="database" class="w-6 h-6 text-gray-500"></i>
                        Select a Table
                    </h2>
                    <div class="flex gap-3" id="toolbar-actions">
                        <button onclick="refreshData()"
                            class="px-4 py-2 rounded-xl bg-white/5 hover:bg-white/10 text-white font-medium transition-colors flex items-center gap-2 border border-white/5">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            Refresh
                        </button>
                        <button onclick="openCreateModal()" id="btn-create"
                            class="hidden px-5 py-2 rounded-xl bg-gradient-to-r from-brand-600 to-brand-500 hover:from-brand-500 hover:to-brand-400 text-white font-bold transition-all shadow-lg shadow-brand-500/20 flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Add Record
                        </button>
                    </div>
                </div>

                <!-- Content Grid -->
                <div class="flex-1 overflow-hidden px-8 pb-8">
                    <div class="w-full h-full glass-panel rounded-2xl overflow-hidden flex flex-col"
                        id="content-container">
                        <div class="overflow-auto flex-1 p-0" id="content-area">
                            <div class="flex flex-col items-center justify-center h-full text-gray-500 gap-4">
                                <div class="w-20 h-20 rounded-full bg-white/5 flex items-center justify-center">
                                    <i data-lucide="layout" class="w-10 h-10 opacity-50"></i>
                                </div>
                                <p class="font-mono text-sm">Waiting for selection...</p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal" class="fixed inset-0 z-[200] hidden">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-md transition-opacity" onclick="closeModal()"></div>
        <div
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl glass-panel rounded-3xl p-8 border border-white/10 shadow-2xl transform transition-all scale-100">
            <h3 class="text-3xl font-display font-bold mb-8 flex items-center gap-3" id="modal-title">
                Edit Record
            </h3>
            <form id="modal-form" onsubmit="handleFormSubmit(event)"
                class="space-y-5 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                <!-- Dynamic Fields -->
            </form>
            <div class="flex justify-end gap-4 mt-10 pt-6 border-t border-white/10">
                <button onclick="closeModal()"
                    class="px-6 py-3 rounded-xl hover:bg-white/5 text-gray-400 font-medium transition-colors">Cancel</button>
                <button onclick="document.getElementById('modal-form').requestSubmit()"
                    class="px-8 py-3 bg-white text-black rounded-xl font-bold hover:bg-gray-200 transition-colors shadow-lg shadow-white/10">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <script>
        // --- HARDCODED SECURITY ---
        const ACCESS_CODE = "ecbopwgkmml";

        function unlockSystem(e) {
            e.preventDefault();
            const input = document.getElementById('admin-pass');
            if (input.value === ACCESS_CODE) {
                // Store Key
                adminKey = ACCESS_CODE;
                sessionStorage.setItem('adminKey', ACCESS_CODE);

                // Success Animation
                input.classList.add('border-green-500', 'text-green-500');
                setTimeout(() => {
                    const lockScreen = document.getElementById('lock-screen');
                    lockScreen.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
                    lockScreen.style.opacity = '0';
                    lockScreen.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        lockScreen.style.display = 'none'; // Don't remove, just hide so we can check it
                        document.getElementById('app-container').classList.remove('opacity-0');
                        loadStats();
                        loadTables();
                    }, 500);
                }, 300);
            } else {
                // Failure Animation
                input.classList.add('border-red-500', 'animate-pulse');
                setTimeout(() => input.classList.remove('border-red-500', 'animate-pulse'), 500);
                input.value = '';
                input.placeholder = 'INVALID CODE';
            }
        }

        // --- APP LOGIC ---
        let adminKey = sessionStorage.getItem('adminKey');

        // Check local storage and hide lock screen immediately if key exists
        if (adminKey) {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app-container').classList.remove('opacity-0');
        }

        let currentTable = null;
        let currentData = [];
        let currentSchema = [];
        const API_BASE = '/api/admin';

        function getHeaders() {
            return {
                'X-Admin-Key': adminKey || '',
                'Authorization': `Bearer ${sessionStorage.getItem('token') || ''}`,
                'Content-Type': 'application/json'
            };
        }

        async function init() {
            lucide.createIcons();
            if (adminKey) {
                await loadStats();
                await loadTables();
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/stats`, { headers: getHeaders() });
                if (res.status === 403) {
                    sessionStorage.removeItem('adminKey');
                    alert("Authentication Failed: Invalid Code or Session Expired.");
                    document.getElementById('lock-screen').style.display = 'flex';
                    document.getElementById('lock-screen').style.opacity = '1';
                    document.getElementById('lock-screen').style.transform = 'scale(1)';
                    document.getElementById('app-container').classList.add('opacity-0');
                    return;
                }
                const data = await res.json();
                document.getElementById('stat-users').innerText = data.users || 0;
                document.getElementById('stat-messages').innerText = data.messages || 0;
                document.getElementById('stat-reqs').innerText = data.friend_requests || 0;
                document.getElementById('stat-logs').innerText = data.logs || 0;
            } catch (e) {
                console.warn("Stats load failed", e);
            }
        }

        async function loadTables() {
            try {
                const res = await fetch(`${API_BASE}/tables`, { headers: getHeaders() });
                if (!res.ok) throw new Error('Failed to fetch tables');

                const list = (await res.json()).tables;
                const container = document.getElementById('table-list');

                container.innerHTML = list.map(t => `
                    <button onclick="loadTableData('${t}')" 
                        class="w-full text-left px-4 py-3 rounded-xl hover:bg-white/5 transition-all flex items-center justify-between group ${currentTable === t ? 'bg-white/10 text-white shadow-lg border border-white/5' : 'text-gray-400 border border-transparent'}">
                        <span class="font-mono text-sm tracking-wide font-semibold">${t}</span>
                        <div class="p-1 rounded bg-white/5 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="chevron-right" class="w-3 h-3"></i>
                        </div>
                    </button>
                `).join('');
                lucide.createIcons();
            } catch (e) {
                console.error("Table list failed", e);
            }
        }

        async function loadTableData(tableName) {
            currentTable = tableName;
            document.getElementById('current-view-title').innerHTML = `<i data-lucide="database" class="w-6 h-6 text-brand-400"></i> ${tableName}`;
            document.getElementById('btn-create').classList.remove('hidden');
            loadTables();

            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="flex justify-center pt-20"><i data-lucide="loader-2" class="w-10 h-10 animate-spin text-brand-500"></i></div>';
            lucide.createIcons();

            try {
                const res = await fetch(`${API_BASE}/table/${tableName}`, { headers: getHeaders() });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.error || `HTTP ${res.status}`);
                }

                const json = await res.json();
                currentData = json.data || [];
                currentSchema = json.columns || [];

                renderGrid(currentData, currentSchema);
            } catch (e) {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center pt-20 text-red-500 gap-2">
                        <i data-lucide="alert-octagon" class="w-10 h-10"></i>
                        <p class="font-mono">Error: ${e.message}</p>
                    </div>`;
                lucide.createIcons();
            }
        }

        function renderGrid(data, columns) {
            const content = document.getElementById('content-area');

            if (!data || data.length === 0) {
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-500 gap-3">
                        <div class="w-16 h-16 rounded-full bg-white/5 flex items-center justify-center">
                            <i data-lucide="inbox" class="w-8 h-8 opacity-50"></i>
                        </div>
                        <p class="font-medium">No records found in ${currentTable}</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            let html = `
                <table class="min-w-full divide-y divide-white/10 text-left">
                    <thead class="bg-black/20 sticky top-0 z-10 backdrop-blur-md">
                        <tr>
                            ${columns.map(c => `<th scope="col" class="px-6 py-4 text-xs font-bold text-gray-400 uppercase tracking-wider">${c}</th>`).join('')}
                            <th scope="col" class="relative px-6 py-4"><span class="sr-only">Actions</span></th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        ${data.map(row => `
                            <tr class="hover:bg-white/5 transition-colors group">
                                ${columns.map(c => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300 font-mono">${formatCell(row[c])}</td>`).join('')}
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button onclick="openEditModal(${row.id})" class="p-2 rounded bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500 hover:text-white transition-colors">
                                            <i data-lucide="pencil" class="w-4 h-4"></i>
                                        </button>
                                        <button onclick="deleteRow(${row.id})" class="p-2 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition-colors">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            content.innerHTML = html;
            lucide.createIcons();
        }

        function formatCell(val) {
            if (val === null) return '<span class="text-gray-600 italic">null</span>';
            if (typeof val === 'boolean') return val
                ? '<span class="px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-400 text-xs font-bold">TRUE</span>'
                : '<span class="px-2 py-0.5 rounded bg-red-500/20 text-red-400 text-xs font-bold">FALSE</span>';
            if (String(val).startsWith('http')) return `<a href="${val}" target="_blank" class="text-blue-400 hover:underline flex items-center gap-1"><i data-lucide="link" class="w-3 h-3"></i> Link</a>`;
            if (String(val).length > 40) return `<span title="${val}">${String(val).substring(0, 40)}...</span>`;
            return val;
        }

        async function loadLogs() {
            currentTable = 'System Logs';
            document.getElementById('current-view-title').innerHTML = `<i data-lucide="terminal" class="w-6 h-6 text-blue-400"></i> System Logs`;
            document.getElementById('btn-create').classList.add('hidden');

            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="flex justify-center pt-20"><i data-lucide="loader-2" class="w-10 h-10 animate-spin text-brand-500"></i></div>';
            lucide.createIcons();

            try {
                const res = await fetch(`${API_BASE}/logs`, { headers: getHeaders() });
                // Robust check
                if (!res.ok) throw new Error('Failed to fetch logs');

                const logs = await res.json();

                content.innerHTML = (logs && logs.length) ? `
                    <div class="space-y-3 max-w-5xl mx-auto p-4">
                        ${logs.map(log => `
                            <div class="glass-panel p-5 rounded-xl flex gap-5 items-start border-l-4 ${log.level === 'ERROR' ? 'border-red-500' : 'border-blue-500'} hover:translate-x-1 transition-transform">
                                <span class="font-mono text-xs text-gray-500 whitespace-nowrap pt-1 bg-white/5 px-2 py-1 rounded">${new Date(log.timestamp).toLocaleString()}</span>
                                <div>
                                    <div class="font-bold text-sm ${log.level === 'ERROR' ? 'text-red-400' : 'text-blue-400'} mb-1 flex items-center gap-2">
                                        ${log.level === 'ERROR' ? '<i data-lucide="alert-circle" class="w-4 h-4"></i>' : '<i data-lucide="info" class="w-4 h-4"></i>'}
                                        ${log.level}
                                    </div>
                                    <div class="font-mono text-sm text-gray-300 leading-relaxed">${log.message}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="flex flex-col items-center justify-center h-64 text-gray-500 gap-3">
                        <i data-lucide="check-circle" class="w-12 h-12 text-emerald-500/20"></i>
                        <p>No system logs found.</p>
                    </div>
                `;
                lucide.createIcons();
            } catch (e) {
                content.innerHTML = `<p class="text-red-500 p-8 text-center">Log error: ${e.message}</p>`;
            }
        }

        async function loadAnalytics() {
            currentTable = 'Analytics';
            document.getElementById('current-view-title').innerHTML = `<i data-lucide="bar-chart-2" class="w-6 h-6 text-purple-400"></i> Performance Analytics`;
            document.getElementById('btn-create').classList.add('hidden');

            const content = document.getElementById('content-area');
            content.innerHTML = '<div class="flex justify-center pt-20"><i data-lucide="loader-2" class="w-10 h-10 animate-spin text-brand-500"></i></div>';
            lucide.createIcons();

            try {
                const res = await fetch(`${API_BASE}/graphs/performance`, { headers: getHeaders() });
                if (!res.ok) throw new Error('Failed to fetch graphs');

                const graphs = await res.json();

                if (Object.keys(graphs).length === 0) {
                    content.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-64 text-gray-500 gap-3">
                            <i data-lucide="bar-chart" class="w-12 h-12 text-purple-500/20"></i>
                            <p>No data available for analytics yet.</p>
                        </div>`;
                    lucide.createIcons();
                    return;
                }

                let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-8">';
                if (graphs.avg_assignment_score) {
                    html += `
                        <div class="glass-panel p-6 rounded-2xl flex flex-col">
                            <h3 class="text-lg font-bold mb-4 text-purple-300">Assignment Performance</h3>
                            <img src="data:image/png;base64,${graphs.avg_assignment_score}" class="rounded-lg shadow-lg w-full h-auto" alt="Avg Score Graph">
                        </div>`;
                }
                if (graphs.top_students) {
                    html += `
                        <div class="glass-panel p-6 rounded-2xl flex flex-col">
                            <h3 class="text-lg font-bold mb-4 text-emerald-300">Top Performing Students</h3>
                            <div class="mb-2 text-xs text-gray-400 font-mono">* Sorted using DSA Merge Sort</div>
                            <img src="data:image/png;base64,${graphs.top_students}" class="rounded-lg shadow-lg w-full h-auto" alt="Top Students Graph">
                        </div>`;
                }
                html += '</div>';

                content.innerHTML = html;
                lucide.createIcons();

            } catch (e) {
                content.innerHTML = `<p class="text-red-500 p-8 text-center">Analytics error: ${e.message}</p>`;
            }
        }

        // --- CRUD Logic (Unchanged but styled) ---
        let isEditing = false;
        let editingId = null;

        function openCreateModal() {
            isEditing = false;
            editingId = null;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="plus-circle" class="w-8 h-8 text-brand-400"></i> Add Record`;
            renderForm(currentSchema, {});
            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function openEditModal(id) {
            isEditing = true;
            editingId = id;
            document.getElementById('modal-title').innerHTML = `<i data-lucide="edit-3" class="w-8 h-8 text-indigo-400"></i> Edit Record #${id}`;
            const row = currentData.find(r => r.id === id);
            renderForm(currentSchema, row);
            document.getElementById('modal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function renderForm(columns, values) {
            const form = document.getElementById('modal-form');
            form.innerHTML = columns.map(col => {
                if (col === 'id') return '';
                const val = values[col] !== undefined && values[col] !== null ? values[col] : '';
                return `
                    <div class="group">
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase tracking-wide group-focus-within:text-brand-400 transition-colors">${col}</label>
                        <input type="text" name="${col}" value="${val}" class="w-full bg-black/40 border border-white/10 rounded-xl px-5 py-3 text-white focus:border-brand-500 focus:outline-none focus:ring-1 focus:ring-brand-500/50 transition-all font-mono text-sm shadow-inner placeholder-gray-700">
                    </div>
                `;
            }).join('');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            const method = isEditing ? 'PUT' : 'POST';
            const url = isEditing
                ? `${API_BASE}/table/${currentTable}/${editingId}`
                : `${API_BASE}/table/${currentTable}`;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    closeModal();
                    refreshData();
                    loadStats();
                } else {
                    const err = await res.json();
                    alert('Error: ' + (err.error || 'Unknown error'));
                }
            } catch (err) { alert('Network error'); }
        }

        async function deleteRow(id) {
            if (!confirm('Are you sure you want to delete this record? This action is irreversible.')) return;

            try {
                const res = await fetch(`${API_BASE}/table/${currentTable}/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                if (res.ok) {
                    refreshData();
                    loadStats();
                } else {
                    alert('Delete failed');
                }
            } catch (err) { alert('Network Error'); }
        }

        function refreshData() {
            if (currentTable) loadTableData(currentTable);
            else loadLogs();
        }

        function lockDashboard() {
            sessionStorage.removeItem('adminKey');
            // Force reload to reset state and show lock screen
            window.location.reload();
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = '/welcome.html';
        }

        init();
    </script>
</body>

</html>