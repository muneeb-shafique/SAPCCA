<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Classes - SAPCCA</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Outfit:wght@500;600;700&display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="js/api-config.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            900: '#0c4a6e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #050505;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.5), transparent);
            transform: translateY(-100%);
            transition: transform 0.5s ease;
        }

        .glass-card:hover .scanner-line {
            transform: translateY(400px);
            transition: transform 1.5s ease;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .bubble-sent {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .bubble-received {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Mobile Menu */
        @media (max-width: 1024px) {
            .mobile-menu-open {
                transform: translateX(0) !important;
            }

            #mobile-backdrop.active {
                display: block;
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="bg-[#050505] text-white overflow-hidden flex h-screen antialiased selection:bg-indigo-500/30 selection:text-indigo-200">

    <!-- MOBILE BACKDROP -->
    <div id="mobile-backdrop"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300 lg:hidden">
    </div>

    <!-- SIDEBAR -->
    <aside
        class="w-64 glass border-r border-white/5 flex flex-col fixed inset-y-0 left-0 z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 bg-[#050505]/95 backdrop-blur-xl lg:bg-transparent lg:static">
        <!-- Logo -->
        <div class="h-20 flex items-center px-6 border-b border-white/5 relative overflow-hidden group">
            <div
                class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
            </div>
            <div
                class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center shadow-[0_0_15px_rgba(79,70,229,0.5)] mr-3 relative z-10">
                <span class="font-display font-bold text-lg">S</span>
            </div>
            <h1
                class="font-display font-bold text-xl tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400 relative z-10">
                SAPCCA
            </h1>
        </div>

        <!-- Links -->
        <nav class="flex-1 px-3 py-6 space-y-1 overflow-y-auto custom-scrollbar">
            <div class="text-xs font-mono font-bold text-gray-500 px-4 mb-2 tracking-wider">APP</div>

            <a href="dashboard_teachers.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-400 rounded-xl hover:text-white hover:bg-white/5 transition-all group">
                <i data-lucide="layout-dashboard" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Dashboard</span>
            </a>

            <a href="chat.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-400 rounded-xl hover:text-white hover:bg-white/5 transition-all group">
                <i data-lucide="message-square" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Messages</span>
            </a>

            <!-- Classes (Active) -->
            <a href="classes.html"
                class="flex items-center gap-3 px-4 py-3 text-white bg-indigo-500/10 rounded-xl border border-indigo-500/20 shadow-[0_0_15px_rgba(99,102,241,0.2)] group relative overflow-hidden">
                <div
                    class="absolute inset-0 bg-gradient-to-r from-indigo-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                </div>
                <i data-lucide="graduation-cap" class="w-5 h-5 text-indigo-400"></i>
                <span class="font-medium">Classes</span>
            </a>

            <a href="friends.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-400 rounded-xl hover:text-white hover:bg-white/5 transition-all group">
                <i data-lucide="users" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Friends</span>
            </a>

            <div class="mt-8 text-xs font-mono font-bold text-gray-500 px-4 mb-2 tracking-wider">SYSTEM</div>

            <a href="settings.html"
                class="flex items-center gap-3 px-4 py-3 text-gray-400 rounded-xl hover:text-white hover:bg-white/5 transition-all group">
                <i data-lucide="settings" class="w-5 h-5 group-hover:text-indigo-400 transition-colors"></i>
                <span class="font-medium">Settings</span>
            </a>
        </nav>

        <!-- User Profile -->
        <div class="p-4 border-t border-white/5">
            <div
                class="glass p-3 rounded-xl flex items-center gap-3 hover:border-indigo-500/30 transition-colors cursor-pointer group">
                <div class="relative">
                    <img id="global-user-avatar" src="https://robohash.org/default"
                        class="w-9 h-9 rounded-lg bg-black/50 border border-white/10 group-hover:border-indigo-500/50 transition-colors">
                    <div
                        class="absolute -bottom-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-[#050505]">
                    </div>
                </div>
                <div class="flex-1 min-w-0">
                    <p id="global-user-name" class="text-sm font-bold text-white truncate">User</p>
                    <p class="text-xs text-gray-400 user-id-display truncate">ID: ...</p>
                </div>
                <button onclick="handleLogout()"
                    class="p-1.5 rounded-lg text-gray-400 hover:text-red-400 hover:bg-red-500/10 transition-colors">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>

    <!-- MAIN DASHBOARD CONTENT -->
    <main id="classes-dashboard"
        class="flex-1 flex flex-col h-screen overflow-hidden relative z-10 transition-all duration-300">
        <header
            class="h-20 border-b border-white/5 flex items-center justify-between px-8 bg-[#050505]/50 backdrop-blur-sm sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <button id="mobile-menu-btn" class="lg:hidden text-gray-400 hover:text-white">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 class="text-xl font-display font-semibold tracking-wide flex items-center gap-2">
                    <span
                        class="w-2 h-6 bg-gradient-to-b from-indigo-500 to-purple-600 rounded-full shadow-[0_0_15px_rgba(139,92,246,0.5)]"></span>
                    <span id="page-title">My Classes</span>
                </h2>
            </div>
            <div class="flex items-center gap-4">
                <button id="create-class-btn"
                    class="hidden px-4 py-2 rounded-lg bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white text-sm font-medium transition-all shadow-lg shadow-indigo-500/20 flex items-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Create Class</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8">
            <div id="classes-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <!-- Classes will be rendered here -->
            </div>
        </div>
    </main>

    <!-- CLASS WORKSPACE (Hidden by default) -->
    <div id="class-workspace"
        class="hidden flex-1 flex h-screen overflow-hidden relative z-10 transition-all duration-300 bg-[#050505]">
        <!-- WORKSPACE SIDEBAR -->
        <aside class="w-80 glass border-r border-white/5 flex flex-col flex-shrink-0 relative z-20">
            <!-- Header -->
            <div class="h-20 flex items-center px-6 border-b border-white/5 gap-3">
                <button id="workspace-back-btn"
                    class="p-2 -ml-2 rounded-lg text-gray-400 hover:text-white hover:bg-white/5 transition-colors">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                </button>
                <div class="flex-1 min-w-0">
                    <h2 id="workspace-class-name" class="text-lg font-bold text-white truncate font-display">Class Name
                    </h2>
                    <p class="text-xs text-indigo-400 font-mono">CLASS WORKSPACE</p>
                </div>
            </div>

            <!-- Groups List -->
            <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">
                <!-- Subject Groups -->
                <div>
                    <div class="flex items-center justify-between px-2 mb-2">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Subject Groups</h3>
                        <button id="create-group-workspace-btn"
                            class="hidden text-gray-500 hover:text-white transition-colors p-1 hover:bg-white/5 rounded">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div id="workspace-groups-list" class="space-y-1">
                        <!-- Groups injected here -->
                    </div>
                </div>
            </div>

            <!-- Footer / Members -->
            <div class="p-4 border-t border-white/5 bg-white/5">
                <button id="workspace-members-btn"
                    class="w-full py-2 px-4 rounded-lg bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 border border-indigo-500/20 flex items-center justify-center gap-2 transition-all">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>View Members</span>
                </button>
            </div>
        </aside>

        <!-- WORKSPACE CHAT AREA -->
        <div class="flex-1 flex flex-col bg-[#050505]/50 relative z-10">
            <!-- Chat Header -->
            <header class="h-20 border-b border-white/5 flex items-center justify-between px-6 glass sticky top-0 z-30">
                <div class="flex items-center gap-4">
                    <div
                        class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold border border-indigo-500/30">
                        <span id="chat-header-icon">#</span>
                    </div>
                    <div>
                        <h3 id="chat-header-name" class="text-lg font-bold text-white">Select a channel</h3>
                        <p id="chat-header-desc" class="text-xs text-gray-400">Join a conversation</p>
                    </div>
                </div>
            </header>

            <!-- Messages Area -->
            <div id="workspace-messages-container"
                class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar scroll-smooth">
                <div class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50">
                    <i data-lucide="message-square" class="w-16 h-16 mb-4"></i>
                    <p>Select a subject group to start chatting</p>
                </div>
            </div>

            <!-- Input Area -->
            <div id="workspace-input-area" class="min-h-[80px] p-4 glass border-t border-white/5 hidden">
                <form id="workspace-chat-form" class="relative flex items-end gap-2 max-w-4xl mx-auto w-full">
                    <!-- File Input -->
                    <input type="file" id="workspace-file-input" class="hidden">
                    <button type="button" onclick="document.getElementById('workspace-file-input').click()"
                        class="p-3 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition-all flex-shrink-0"
                        title="Upload File">
                        <i data-lucide="paperclip" class="w-5 h-5"></i>
                    </button>

                    <div
                        class="flex-1 bg-[#111317] border border-white/10 rounded-xl p-3 focus-within:border-indigo-500/50 focus-within:ring-1 focus-within:ring-indigo-500/50 transition-all">
                        <input type="text" id="workspace-chat-input"
                            class="w-full bg-transparent border-none focus:outline-none text-white placeholder-gray-500 max-h-32 overflow-y-auto resize-none"
                            placeholder="Type a message..." autocomplete="off">
                    </div>
                    <button type="submit"
                        class="p-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl shadow-lg shadow-indigo-500/20 transition-all flex-shrink-0">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Subject Group Modal -->
    <div id="create-group-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-4">
        <div
            class="glass-card w-full max-w-md p-8 rounded-2xl border border-white/10 shadow-2xl scale-95 transition-all duration-300">
            <h3 class="text-2xl font-display font-bold text-white mb-6">Create Subject Group</h3>
            <form id="create-group-form" class="space-y-6">
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-2">GROUP NAME</label>
                    <input type="text" id="group-name-input" required
                        class="w-full bg-[#050505] border border-white/10 rounded-lg p-3 text-white focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition-all placeholder-gray-700"
                        placeholder="e.g. Mathematics 101">
                </div>
                <div>
                    <label class="block text-xs font-mono text-gray-400 mb-2">DESCRIPTION</label>
                    <textarea id="group-desc-input" rows="3"
                        class="w-full bg-[#050505] border border-white/10 rounded-lg p-3 text-white focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500 transition-all placeholder-gray-700"
                        placeholder="What is this group about?"></textarea>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeCreateGroupModal()"
                        class="flex-1 py-3 rounded-lg border border-white/10 text-gray-400 hover:text-white hover:bg-white/5 font-medium transition-all">Cancel</button>
                    <button type="submit"
                        class="flex-1 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition-all shadow-lg shadow-indigo-500/20">
                        Create Group
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Class Members Modal -->
    <div id="members-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300 flex items-center justify-center p-4">
        <div
            class="glass-card w-full max-w-lg p-0 rounded-2xl border border-white/10 shadow-2xl scale-95 transition-all duration-300 overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b border-white/5 flex items-center justify-between bg-[#050505]/50">
                <h3 class="text-xl font-display font-bold text-white flex items-center gap-2">
                    <i data-lucide="users" class="w-5 h-5 text-indigo-400"></i>
                    Class Members
                </h3>
                <button onclick="closeMembersModal()" class="text-gray-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="p-4 border-b border-white/5 bg-[#050505]/30 flex gap-2">
                <input type="text" id="add-member-input"
                    class="flex-1 bg-[#111317] border border-white/10 rounded-lg p-2 text-sm text-white focus:border-indigo-500 focus:outline-none"
                    placeholder="Enter email to add member...">
                <button onclick="addMember()"
                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-sm font-bold rounded-lg transition-all">
                    Add
                </button>
            </div>

            <div id="members-list-container" class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar">
                <!-- Members rendered here -->
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div id="create-class-modal"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300">
        <div class="w-full h-full flex items-center justify-center p-4">
            <div
                class="glass-card w-full max-w-md p-6 rounded-2xl border border-indigo-500/20 bg-[#111317] transform scale-95 transition-transform duration-300">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-display font-bold text-white">Create Class</h3>
                        <p class="text-xs text-indigo-400 font-mono mt-1">FACULTY ONLY // COMMUNITY CHANNEL</p>
                    </div>
                    <button id="close-modal-btn" class="text-gray-500 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <form id="create-class-form">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-mono text-gray-500 mb-2">CLASS NAME</label>
                            <input type="text" id="class-name-input" required
                                class="w-full bg-[#050505] border border-white/10 rounded-lg p-3 text-white focus:border-indigo-500 focus:outline-none placeholder-gray-700"
                                placeholder="e.g. Computer Science - Fall 2025">
                        </div>
                        <div>
                            <label class="block text-xs font-mono text-gray-500 mb-2">DESCRIPTION</label>
                            <textarea id="class-desc-input" rows="3"
                                class="w-full bg-[#050505] border border-white/10 rounded-lg p-3 text-white focus:border-indigo-500 focus:outline-none placeholder-gray-700"
                                placeholder="Class description and details..."></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="button" id="cancel-btn"
                                class="flex-1 py-3 rounded-lg border border-white/10 text-gray-400 hover:bg-white/10 hover:text-white transition-all">Cancel</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-lg bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold transition-all shadow-[0_0_20px_rgba(139,92,246,0.3)]">
                                <i data-lucide="graduation-cap" class="w-4 h-4 inline mr-2"></i>Create
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="notification-toast"
        class="fixed bottom-8 right-8 z-50 transform translate-y-32 opacity-0 transition-all duration-300">
        <div class="glass p-4 rounded-xl border-l-4 border-indigo-500 shadow-2xl flex items-center gap-4 min-w-[300px]">
            <div class="bg-indigo-500/20 p-2 rounded-full">
                <i data-lucide="check-circle" class="w-5 h-5 text-indigo-400"></i>
            </div>
            <div>
                <h4 class="text-white font-bold text-sm">Success</h4>
                <p class="text-gray-400 text-xs">Operation completed</p>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- STATE ---
        let currentUser = null;
        let currentUserRole = '';
        let classes = [];
        let activeClassId = null;
        let activeGroupId = null;
        let activeGroupIsMember = false;
        let socket = null;
        let currentClassMembers = [];

        // --- DOM ELEMENTS ---
        const DOM = {
            mainDashboard: document.getElementById('classes-dashboard'),
            workspace: document.getElementById('class-workspace'),
            classesContainer: document.getElementById('classes-container'),

            // Workspace Header & Sidebar
            workspaceBackBtn: document.getElementById('workspace-back-btn'),
            workspaceClassName: document.getElementById('workspace-class-name'),
            workspaceGroupsList: document.getElementById('workspace-groups-list'),
            createGroupBtn: document.getElementById('create-group-workspace-btn'),
            viewMembersBtn: document.getElementById('workspace-members-btn'),

            // Chat Area
            chatHeaderName: document.getElementById('chat-header-name'),
            chatHeaderDesc: document.getElementById('chat-header-desc'),
            chatHeaderIcon: document.getElementById('chat-header-icon'),
            messagesContainer: document.getElementById('workspace-messages-container'),
            inputArea: document.getElementById('workspace-input-area'),
            chatForm: document.getElementById('workspace-chat-form'),
            chatInput: document.getElementById('workspace-chat-input'),
            fileInput: document.getElementById('workspace-file-input'),

            // Modals
            createGroupModal: document.getElementById('create-group-modal'),
            createGroupForm: document.getElementById('create-group-form'),
            membersModal: document.getElementById('members-modal'),
            membersListContainer: document.getElementById('members-list-container'),
            addMemberInput: document.getElementById('add-member-input'),

            // Common
            toast: document.getElementById('notification-toast')
        };

        // --- INITIALIZATION ---
        async function init() {
            // Check Auth
            const userStr = sessionStorage.getItem('user');
            if (!userStr) {
                window.location.href = '/welcome.html';
                return;
            }
            currentUser = JSON.parse(userStr);
            currentUserRole = currentUser.role || 'student';

            // Setup UI based on user
            setupUserUI();

            // Initialize Socket
            initSocket();

            // Load Classes
            await loadClasses();

            // Setup Event Listeners
            setupEventListeners();

            // Poll for new messages (auto-refresh every 3 seconds)
            setInterval(() => {
                if (activeGroupId) {
                    loadGroupMessages(activeGroupId);
                }
            }, 3000);
        }

        function setupUserUI() {
            document.getElementById('global-user-name').textContent = currentUser.name;
            document.querySelector('.user-id-display').textContent = `ID: ${currentUser.id}`;
            document.getElementById('global-user-avatar').src = `https://robohash.org/${currentUser.id}?set=set4&bgset=bg2`;

            const isFaculty = ['faculty', 'teacher', 'professor', 'admin'].includes(currentUserRole.toLowerCase());
            if (isFaculty) {
                document.getElementById('create-class-btn').classList.remove('hidden');
                document.getElementById('create-class-btn').classList.add('flex');
                document.getElementById('page-title').textContent = 'Manage Classes';
            } else {
                document.getElementById('page-title').textContent = 'My Classes';
            }
        }

        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('ðŸŸ¢ Socket connected');
            });

            socket.on('new_group_message', (msg) => {
                if (activeGroupId && String(msg.group_id) === String(activeGroupId)) {
                    appendMessage(msg);
                }
            });
        }

        function setupEventListeners() {
            DOM.workspaceBackBtn.onclick = exitWorkspace;

            DOM.chatForm.onsubmit = async (e) => {
                e.preventDefault();
                await sendMessage();
            };

            DOM.viewMembersBtn.onclick = openMembersModal;

            DOM.createGroupForm.onsubmit = handleCreateGroupSubmit;

            // File Input Listener
            DOM.fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    showToast('Error', 'File > 5MB', true);
                    return;
                }

                const reader = new FileReader();
                reader.onload = async (ev) => {
                    const data = ev.target.result;
                    const token = sessionStorage.getItem('token');

                    try {
                        await fetch('/api/groups/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify({
                                group_id: activeGroupId,
                                message: '',
                                file_data: data,
                                file_name: file.name,
                                file_type: file.type,
                                file_category: getCategoryFromType(file.type)
                            })
                        });
                        // Refresh messages
                        await loadGroupMessages(activeGroupId);
                        showToast('Success', 'File sent');
                    } catch (e) {
                        console.error('[FILE] Upload Error:', e);
                        showToast('Error', 'Upload failed', true);
                    }

                    DOM.fileInput.value = '';
                };
                reader.readAsDataURL(file);
            };

            // Mobile menu handlers (existing)
            const mobileBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.querySelector('aside');
            const backdrop = document.getElementById('mobile-backdrop');

            if (mobileBtn && sidebar && backdrop) {
                mobileBtn.addEventListener('click', () => {
                    sidebar.classList.add('mobile-menu-open');
                    backdrop.classList.add('active');
                });
                backdrop.addEventListener('click', () => {
                    sidebar.classList.remove('mobile-menu-open');
                    backdrop.classList.remove('active');
                });
            }
        }

        // --- CLASSES LOGIC ---
        async function loadClasses() {
            try {
                const token = sessionStorage.getItem('token');
                const res = await fetch('/api/classes/list', { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if (res.ok && data.classes) {
                    classes = data.classes;
                    renderClasses();
                }
            } catch (e) {
                console.error('Load classes error:', e);
            }
        }

        function renderClasses() {
            const container = DOM.classesContainer;
            container.innerHTML = '';

            if (classes.length === 0) {
                const isFaculty = ['faculty', 'teacher', 'professor', 'admin'].includes(currentUserRole.toLowerCase());
                container.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-20 text-center">
                        <div class="w-24 h-24 rounded-2xl bg-white/5 flex items-center justify-center mb-6">
                            <i data-lucide="graduation-cap" class="w-12 h-12 text-gray-500"></i>
                        </div>
                        <h3 class="text-2xl font-display font-bold text-white mb-3">No Classes Found</h3>
                        <p class="text-gray-400 max-w-md mb-6">
                            ${isFaculty ? 'Create a class to get started.' : 'You are not enrolled in any classes yet.'}
                        </p>
                         ${isFaculty ? '<button onclick="openCreateModal()" class="px-6 py-3 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white font-bold transition-all">Create Class</button>' : ''}
                    </div>
                 `;
                return;
            }

            classes.forEach(cls => {
                const card = document.createElement('div');
                card.className = 'glass-card p-6 rounded-xl cursor-pointer hover:border-indigo-500/40 transition-all group';
                card.innerHTML = `
                    <div class="scanner-line"></div>
                    <div class="flex items-start justify-between mb-4">
                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/30 group-hover:shadow-indigo-500/50 transition-all">
                            <i data-lucide="graduation-cap" class="w-7 h-7 text-white"></i>
                        </div>
                        ${cls.is_moderator ? '<span class="text-xs bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded-full border border-indigo-500/30 font-mono font-bold">MODERATOR</span>' : ''}
                    </div>
                    <h3 class="text-lg font-display font-bold text-white mb-2 group-hover:text-indigo-300 transition-colors">${cls.name}</h3>
                    <p class="text-sm text-gray-400 mb-4 line-clamp-2">${cls.description || 'No description provided'}</p>
                    <div class="flex items-center justify-between pt-4 border-t border-white/5">
                        <span class="flex items-center gap-1.5 text-xs text-gray-500"><i data-lucide="folder" class="w-3.5 h-3.5"></i> ${cls.group_count} subjects</span>
                        <span class="flex items-center gap-1.5 text-xs text-gray-500"><i data-lucide="users" class="w-3.5 h-3.5"></i> ${cls.member_count} members</span>
                    </div>
                `;
                card.onclick = () => enterClass(cls.id);
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        async function enterClass(classId) {
            activeClassId = classId;

            // Switch View
            DOM.mainDashboard.classList.add('hidden');
            DOM.workspace.classList.remove('hidden');

            // 1. Fetch Details
            try {
                const token = sessionStorage.getItem('token');
                const res = await fetch(`/api/classes/${classId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to load class details');

                const data = await res.json();
                const cls = data.class;
                const groups = data.groups || [];
                currentClassMembers = data.members || [];

                // Update Sidebar Header
                DOM.workspaceClassName.textContent = cls.name;

                // Show Create Group Button if moderator
                if (cls.is_moderator) {
                    DOM.createGroupBtn.classList.remove('hidden');
                    DOM.createGroupBtn.onclick = () => openCreateGroupModal(classId);
                } else {
                    DOM.createGroupBtn.classList.add('hidden');
                }

                // Render Groups
                renderGroupsSidebar(groups);

                // Reset Chat Area
                DOM.chatHeaderName.textContent = 'Select a Group';
                DOM.chatHeaderDesc.textContent = 'Choose a subject group from the sidebar';
                DOM.messagesContainer.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50">
                        <i data-lucide="message-square" class="w-16 h-16 mb-4"></i>
                        <p>Select a subject group to start chatting</p>
                    </div>
                `;
                DOM.inputArea.classList.add('hidden');

            } catch (e) {
                console.error("Enter Class Error:", e);
                showToast('Error', 'Failed to load class details', true);
            }
        }

        function exitWorkspace() {
            activeClassId = null;
            activeGroupId = null;
            DOM.workspace.classList.add('hidden');
            DOM.mainDashboard.classList.remove('hidden');
        }

        function renderGroupsSidebar(groups) {
            DOM.workspaceGroupsList.innerHTML = '';

            if (groups.length === 0) {
                DOM.workspaceGroupsList.innerHTML = `<div class="p-2 text-xs text-center text-gray-500 italic">No subject groups yet</div>`;
                return;
            }

            groups.forEach(g => {
                const el = document.createElement('button');
                el.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-white/5 transition-colors flex items-center gap-3 group';
                el.innerHTML = `
                    <span class="w-6 h-6 rounded flex items-center justify-center bg-indigo-500/20 text-indigo-400 text-xs font-bold border border-indigo-500/30">#</span>
                    <span class="text-sm text-gray-300 font-medium group-hover:text-white truncate">${g.name}</span>
                `;
                el.onclick = () => openGroupChat(g);
                DOM.workspaceGroupsList.appendChild(el);
            });
        }

        // --- CHAT LOGIC ---
        async function openGroupChat(group) {
            activeGroupId = group.id;
            activeGroupIsMember = group.is_member; // From API details

            // Join Socket Room
            socket.emit('join_room', { room: String(group.id) });

            // UI Updates
            DOM.chatHeaderName.textContent = group.name;
            DOM.chatHeaderDesc.textContent = group.description || 'Subject Group';
            DOM.chatHeaderIcon.textContent = group.name.substring(0, 1).toUpperCase();

            DOM.messagesContainer.innerHTML = ''; // Loading...

            // Auto-join if not member (works for class groups)
            if (!activeGroupIsMember) {
                const joined = await joinGroup(group.id, true);
                if (joined) {
                    activeGroupIsMember = true;
                }
            }

            // Show input and load messages
            if (activeGroupIsMember) {
                DOM.inputArea.classList.remove('hidden');
                await loadGroupMessages(group.id);
            } else {
                // Failed to join
                DOM.inputArea.classList.add('hidden');
                DOM.messagesContainer.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center">
                        <div class="max-w-md text-center p-8 glass rounded-2xl">
                            <i data-lucide="lock" class="w-16 h-16 text-gray-500 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Access Denied</h3>
                            <p class="text-gray-400 mb-6">You don't have permission to join this group.</p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        async function joinGroup(groupId, isSilent = false) {
            try {
                const token = sessionStorage.getItem('token');

                const res = await fetch('/api/groups/join', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ group_id: groupId })
                });

                if (res.ok) {
                    if (!isSilent) showToast('Success', 'Joined Group');
                    activeGroupIsMember = true;
                    DOM.inputArea.classList.remove('hidden');
                    return true;
                } else {
                    const err = await res.json();
                    if (!isSilent) showToast('Error', err.error || 'Failed to join', true);
                    return false;
                }
            } catch (e) {
                console.error('Join group error:', e);
                return false;
            }
        }

        async function loadGroupMessages(groupId) {
            try {
                const token = sessionStorage.getItem('token');
                const res = await fetch(`/api/groups/messages/${groupId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json();

                if (res.ok && data.messages) {
                    DOM.messagesContainer.innerHTML = '';
                    if (data.messages.length === 0) {
                        DOM.messagesContainer.innerHTML = `
                            <div class="h-full flex flex-col items-center justify-center text-gray-500 opacity-50">
                                <p>No messages yet. Say hello!</p>
                            </div>
                        `;
                    }
                    data.messages.forEach(msg => appendMessage(msg));
                    DOM.messagesContainer.scrollTop = DOM.messagesContainer.scrollHeight;
                }
            } catch (e) {
                console.error('Load messages error:', e);
            }
        }

        function appendMessage(msg) {
            const isMe = String(msg.sender_id) === String(currentUser.id);
            const isEmpty = DOM.messagesContainer.querySelector('.items-center');
            if (isEmpty && isEmpty.innerText.includes('No messages yet')) isEmpty.remove();

            const div = document.createElement('div');
            div.className = `flex w-full mb-4 gap-3 ${isMe ? 'justify-end' : 'justify-start'}`;

            // Content Rendering (File vs Text)
            let contentHtml = '';

            // Check for File
            if (msg.file_data) { // snake_case from python
                const cat = msg.file_category || getCategoryFromType(msg.file_type || '');
                const fileSizeInfo = ''; // Don't have size readily available without calc, omitting for speed.

                if (cat === 'photo') {
                    contentHtml += `<div class="mb-2"><img src="${msg.file_data}" class="max-w-xs rounded-lg cursor-pointer hover:opacity-90 border border-white/10" onclick="window.open('${msg.file_data}', '_blank')"></div>`;
                } else if (cat === 'video') {
                    contentHtml += `<div class="mb-2"><video src="${msg.file_data}" controls class="max-w-xs rounded-lg bg-black"></video></div>`;
                } else if (cat === 'audio') {
                    contentHtml += `<div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg mb-2 border border-white/10"><i data-lucide="music" class="w-6 h-6 text-orange-400"></i><audio src="${msg.file_data}" controls class="max-w-[200px]"></audio></div>`;
                } else {
                    contentHtml += `
                        <div class="flex items-center gap-3 p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-colors mb-2 border border-white/10">
                            <i data-lucide="file-text" class="w-6 h-6 text-blue-400"></i>
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium truncate text-white">${msg.file_name || 'File'}</div>
                            </div>
                            <a href="${msg.file_data}" download="${msg.file_name || 'file'}" class="p-2 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white"><i data-lucide="download" class="w-4 h-4"></i></a>
                        </div>`;
                }
            }

            if (msg.text) {
                contentHtml += `<div>${msg.text}</div>`;
            }

            // Bubble
            const bubbleHtml = `
                <div class="p-3 rounded-2xl text-sm leading-relaxed relative z-10 ${isMe ? 'bubble-sent text-white rounded-tr-sm' : 'bubble-received text-gray-200 rounded-tl-sm'}">
                    ${contentHtml}
                </div>
                 <div class="text-[10px] text-gray-500 mt-1 font-mono ${isMe ? 'text-right' : 'text-left'}">
                     ${(!isMe) ? `<span class="text-indigo-400 mr-2 font-bold">${msg.sender_name || 'User'}</span>` : ''} 
                     ${new Date(msg.time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                </div>
            `;

            div.innerHTML = `
                ${!isMe ? `<div class="w-8 h-8 rounded-full flex-shrink-0 overflow-hidden bg-gray-800 border border-white/10"><img src="${msg.sender_avatar || 'https://robohash.org/' + msg.sender_id}" class="w-full h-full object-cover"></div>` : ''}
                <div class="max-w-[75%] group relative">
                    ${bubbleHtml}
                </div>
            `;

            DOM.messagesContainer.appendChild(div);
            DOM.messagesContainer.scrollTop = DOM.messagesContainer.scrollHeight;
            lucide.createIcons();
        }

        async function sendMessage() {
            const text = DOM.chatInput.value.trim();
            if (!text || !activeGroupId) return;

            const token = sessionStorage.getItem('token');
            DOM.chatInput.value = '';

            try {
                await fetch('/api/groups/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ group_id: activeGroupId, message: text })
                });
                // Refresh messages
                await loadGroupMessages(activeGroupId);
            } catch (e) {
                console.error('Send message error:', e);
                showToast('Error', 'Failed to send message', true);
            }
        }

        // --- HELPERS ---
        function getCategoryFromType(mime) {
            if (!mime) return 'document';
            if (mime.startsWith('image/')) return 'photo';
            if (mime.startsWith('video/')) return 'video';
            if (mime.startsWith('audio/')) return 'audio';
            return 'document';
        }

        // --- MODAL HANDLERS ---

        // Create Group
        function openCreateGroupModal() {
            DOM.createGroupModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.createGroupModal.classList.remove('opacity-0');
                DOM.createGroupModal.querySelector('.glass-card').classList.remove('scale-95');
            }, 10);
        }

        window.closeCreateGroupModal = function () {
            const modal = DOM.createGroupModal;
            modal.classList.add('opacity-0');
            modal.querySelector('.glass-card').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function handleCreateGroupSubmit(e) {
            e.preventDefault();
            if (!activeClassId) return;

            const name = document.getElementById('group-name-input').value;
            const description = document.getElementById('group-desc-input').value;

            try {
                const token = sessionStorage.getItem('token');
                const res = await fetch('/api/groups/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name, description, class_id: activeClassId })
                });

                if (res.ok) {
                    showToast('Success', 'Group created');
                    closeCreateGroupModal();
                    DOM.createGroupForm.reset();
                    // Reload workspace
                    enterClass(activeClassId);
                } else {
                    const err = await res.json();
                    showToast('Error', err.error, true);
                }
            } catch (e) { console.error(e); }
        }

        // Members Modal
        function openMembersModal() {
            renderMembersList();
            DOM.membersModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.membersModal.classList.remove('opacity-0');
                DOM.membersModal.querySelector('.glass-card').classList.remove('scale-95');
            }, 10);
        }

        window.closeMembersModal = function () {
            const modal = DOM.membersModal;
            modal.classList.add('opacity-0');
            modal.querySelector('.glass-card').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        window.addMember = async function () {
            const email = DOM.addMemberInput.value.trim();
            if (!email || !activeClassId) return;

            try {
                const token = sessionStorage.getItem('token');
                // Use class add-members endpoint
                const res = await fetch('/api/classes/add-members', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ class_id: activeClassId, emails: [email] })
                });

                const data = await res.json();
                if (res.ok) {
                    if (data.errors && data.errors.length > 0) {
                        showToast('Warning', data.errors[0], true);
                    } else {
                        showToast('Success', 'Member added');
                        DOM.addMemberInput.value = '';
                        // Refresh details
                        const res2 = await fetch(`/api/classes/${activeClassId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                        const data2 = await res2.json();
                        currentClassMembers = data2.members;
                        renderMembersList();
                    }
                } else {
                    showToast('Error', data.error, true);
                }
            } catch (e) { console.error(e); }
        }

        function renderMembersList() {
            const container = DOM.membersListContainer;
            container.innerHTML = '';

            if (currentClassMembers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No members found</p>';
                return;
            }

            const isModerator = !DOM.createGroupBtn.classList.contains('hidden');

            if (!isModerator) {
                DOM.addMemberInput.parentElement.classList.add('hidden');
            } else {
                DOM.addMemberInput.parentElement.classList.remove('hidden');
            }

            currentClassMembers.forEach(m => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 rounded-lg bg-white/5';
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-xs font-bold text-white">
                            ${m.name.substring(0, 2).toUpperCase()}
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white">${m.name}</p>
                            <p class="text-xs text-gray-400">${m.email}</p>
                        </div>
                    </div>
                    ${m.is_moderator ? '<span class="text-xs bg-indigo-500/20 text-indigo-400 px-2 py-1 rounded font-mono">MOD</span>' : ''}
                `;
                container.appendChild(div);
            });
        }

        // --- HELPERS ---
        function showToast(title, msg, isError = false) {
            const toast = DOM.toast;
            toast.querySelector('h4').textContent = title;
            toast.querySelector('p').textContent = msg;
            toast.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => toast.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        function openCreateModal() {
            document.getElementById('create-class-modal').classList.remove('hidden', 'opacity-0');
            document.getElementById('create-class-modal').querySelector('.glass-card').classList.remove('scale-95');
        }

        document.getElementById('create-class-form').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('class-name-input').value;
            try {
                const token = sessionStorage.getItem('token');
                const description = document.getElementById('class-desc-input').value || '';

                const res = await fetch('/api/classes/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ name, description })
                });

                if (res.ok) {
                    document.getElementById('create-class-modal').classList.add('hidden');
                    loadClasses();
                    showToast('Success', 'Class created');
                }
            } catch (e) { console.error(e); }
        };

        document.getElementById('close-modal-btn').onclick = () => {
            document.getElementById('create-class-modal').classList.add('hidden');
        };

        if (document.getElementById('cancel-btn')) {
            document.getElementById('cancel-btn').onclick = () => {
                document.getElementById('create-class-modal').classList.add('hidden');
            };
        }

        init();
    </script>
    <script src="js/integration.js"></script>
</body>

</html>